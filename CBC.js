// ==UserScript==
// @name         Bilibili CDN Switcher
// @name:zh-CN   哔哩哔哩 CDN 切换器
// @namespace    bilibili-cdn-switcher
// @version      1.2.0
// @description  Combines the best features for switching Bilibili's video CDN. Dynamic UI in settings panel, wide compatibility, and mobile support.
// @description:zh-CN 结合了动态UI、广泛的页面兼容性和移动端支持的哔哩哔哩视频CDN切换脚本，提供最佳体验。设置项位于播放器设置面板中。此版本经过性能和稳定性优化。
// @author       Generated by Copilot & Optimized by AI
// @license      MIT
// @run-at       document-start
// @match        *://www.bilibili.com/*
// @match        *://m.bilibili.com/*
// @match        *://live.bilibili.com/blanc/*
// @match        *://music.bilibili.com/pc/*
// @connect      kanda-akihito-kun.github.io
// @grant        GM_xmlhttpRequest
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        unsafeWindow
// ==/UserScript==

(function () {
    'use strict';

    // --- 配置区域 ---
    const API_BASE_URL = 'https://kanda-akihito-kun.github.io/ccb/api';
    const PLUGIN_NAME = 'BiliCDN-Ultimate-Opt';

    // --- 全局变量和工具函数 ---
    const log = console.log.bind(console, `[${PLUGIN_NAME}]:`);
    const isMobile = location.host === 'm.bilibili.com';

    const STORED_CDN_NODE_KEY = 'ULTIMATE_CDN_NODE';
    const STORED_REGION_KEY = 'ULTIMATE_CDN_REGION';
    const DEFAULT_CDN_NODE_TEXT = '使用默认源';

    const Language = (() => {
        const lang = (navigator.language || navigator.browserLanguage || (navigator.languages || ["en"])[0]).substring(0, 2);
        return (lang === 'zh' || lang === 'ja') ? lang : 'en';
    })();

    // 初始/备用 CDN 列表（当 API 请求失败时使用）
    const FALLBACK_CDN_LIST = [
        'upos-sz-mirroraliov.bilivideo.com',
        'upos-sz-mirroralib.bilivideo.com',
        'upos-sz-mirrorcos.bilivideo.com',
        'upos-sz-mirrorhw.bilivideo.com',
        'upos-sz-mirrorakam.bilivideo.com',
    ];
    let cdnList = [DEFAULT_CDN_NODE_TEXT, ...FALLBACK_CDN_LIST];
    let regionList = ['-'];

    // --- 核心功能 ---

    const getSelectedCdn = () => GM_getValue(STORED_CDN_NODE_KEY, DEFAULT_CDN_NODE_TEXT);
    const isCdnReplacementEnabled = () => getSelectedCdn() !== DEFAULT_CDN_NODE_TEXT;

    const getReplacementUrl = () => {
        if (!isCdnReplacementEnabled()) return null;
        let domain = getSelectedCdn();
        if (domain.indexOf('://') === -1) {
            domain = 'https://' + domain;
        }
        return domain.endsWith('/') ? domain : `${domain}/`;
    };

    /**
     * [优化点 1] 使用 GM_xmlhttpRequest 实现网络请求，更可靠
     */
    const gmFetch = (url) => {
        return new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                method: 'GET',
                url: url,
                onload: function (response) {
                    if (response.status >= 200 && response.status < 300) {
                        try {
                            resolve(JSON.parse(response.responseText));
                        } catch (e) {
                            log(`解析数据失败: ${url}`, e);
                            reject(new Error('JSON parsing failed'));
                        }
                    } else {
                        reject(new Error(`HTTP error! status: ${response.status}`));
                    }
                },
                onerror: function (error) {
                    log(`获取数据失败: ${url}`, error);
                    reject(error);
                }
            });
        });
    };

    const fetchJson = async (url) => {
        try {
            return await gmFetch(url);
        } catch (error) {
            log(`请求失败: ${url}`, error.message);
            return null;
        }
    };

    const updateRegionList = async () => {
        const data = await fetchJson(`${API_BASE_URL}/region.json`);
        if (data && Array.isArray(data)) {
            regionList = ["-", ...data];
            log(`地区列表已更新: ${data.join(', ')}`);
        } else {
            log('无法从 API 获取地区列表，将使用默认值。');
        }
    };

    /**
     * [优化点 3] 解耦数据获取与 UI 更新
     */
    const getCdnListByRegion = async (region) => {
        if (region === '-') {
            log('已切换到备用 CDN 列表。');
            return [DEFAULT_CDN_NODE_TEXT, ...FALLBACK_CDN_LIST];
        }
        const data = await fetchJson(`${API_BASE_URL}/cdn.json`);
        if (data && data[region]) {
            log(`已更新 ${region} 地区的 CDN 列表。`);
            return [DEFAULT_CDN_NODE_TEXT, ...data[region]];
        }
        log(`无法获取 ${region} 地区的 CDN 列表，将使用备用列表。`);
        return [DEFAULT_CDN_NODE_TEXT, ...FALLBACK_CDN_LIST];
    };

    const playInfoTransformer = (playInfo) => {
        // ... (此部分逻辑不变)
        const replacementUrl = getReplacementUrl();
        if (!replacementUrl) return;
        const urlTransformer = (target) => {
            if (target && target.base_url) {
                target.base_url = target.base_url.replace(/https:\/\/.*?\//, replacementUrl);
                target.baseUrl = target.base_url;
            }
        };
        const durlTransformer = (target) => {
            if (target && target.url) {
                target.url = target.url.replace(/https:\/\/.*?\//, replacementUrl);
            }
        };
        if (playInfo.code !== 0 && playInfo.code !== undefined) {
            log('获取播放信息失败, message:', playInfo.message);
            return;
        }
        const data = playInfo.data || playInfo.result || {};
        try {
            if (data.dash) {
                data.dash.video?.forEach(urlTransformer);
                data.dash.audio?.forEach(urlTransformer);
            } else if (data.durl) {
                data.durl.forEach(durlTransformer);
            }
            if (data.video_info?.dash) {
                data.video_info.dash.video?.forEach(urlTransformer);
                data.video_info.dash.audio?.forEach(urlTransformer);
            }
        } catch (err) {
            log('处理播放信息时发生未知错误:', err, playInfo);
        }
    };

    const mobileOptionsTransformer = (options) => {
        const replacementUrl = getReplacementUrl();
        if (replacementUrl && options && options.readyVideoUrl) {
            options.readyVideoUrl = options.readyVideoUrl.replace(/https:\/\/.*?\//, replacementUrl);
        }
    };

    // --- 拦截器与挂钩 ---

    const interceptNetworkRequests = (windowContext) => {
        const OriginalXMLHttpRequest = windowContext.XMLHttpRequest;
        const OriginalFetch = windowContext.fetch;

        const handleResponse = (responseText, url) => {
            if (!isCdnReplacementEnabled() || !responseText || typeof responseText !== 'string') return responseText;
            const isPlayUrlApi = url.includes('api.bilibili.com') && url.includes('playurl');
            if (isPlayUrlApi) {
                log('(Intercepted) playurl api response.');
                try {
                    const playInfo = JSON.parse(responseText);
                    playInfoTransformer(playInfo);
                    return JSON.stringify(playInfo);
                } catch (e) {
                    log('拦截器解析JSON失败', e);
                }
            }
            return responseText;
        };

        /**
         * [优化点 2] 优化 XMLHttpRequest 拦截器，避免重复处理
         */
        windowContext.XMLHttpRequest = class extends OriginalXMLHttpRequest {
            constructor(...args) {
                super(...args);
                this._isHandled = false;
                this._modifiedResponse = null;
                this.addEventListener('load', () => {
                    if (this.responseURL.includes('playurl')) {
                        this._modifiedResponse = handleResponse(super.responseText, this.responseURL);
                        this._isHandled = true;
                    }
                });
            }
            get responseText() {
                return this._isHandled ? this._modifiedResponse : super.responseText;
            }
            get response() {
                return this._isHandled ? this._modifiedResponse : super.response;
            }
        };

        windowContext.fetch = async (input, init) => {
            const url = typeof input === 'string' ? input : input.url;
            const response = await OriginalFetch(input, init);

            if (isCdnReplacementEnabled() && url.includes('api.bilibili.com') && url.includes('playurl')) {
                const originalText = await response.text();
                const modifiedText = handleResponse(originalText, url);
                return new Response(modifiedText, {
                    status: response.status,
                    statusText: response.statusText,
                    headers: response.headers
                });
            }
            return response;
        };
    };

    const hookWindowPlayInfo = () => {
        if (isMobile) return;
        let internalPlayInfo = unsafeWindow.__playinfo__;
        if (isCdnReplacementEnabled() && internalPlayInfo) playInfoTransformer(internalPlayInfo);
        Object.defineProperty(unsafeWindow, '__playinfo__', {
            get: () => internalPlayInfo,
            set: v => { if (isCdnReplacementEnabled()) playInfoTransformer(v); internalPlayInfo = v; },
            configurable: true
        });
    };

    const hookMobileOptions = () => {
        if (!isMobile) return;
        let internalOptions = unsafeWindow.options;
        if (isCdnReplacementEnabled() && internalOptions) mobileOptionsTransformer(internalOptions);
        Object.defineProperty(unsafeWindow, 'options', {
            get: () => internalOptions,
            set: v => { if (isCdnReplacementEnabled()) mobileOptionsTransformer(v); internalOptions = v; },
            configurable: true
        });
    };

    // --- UI 创建与注入 ---

    const SettingsBarTitle = {
        'zh': 'CDN 切换器', 'en': 'CDN Switcher', 'ja': 'CDNスイッチャー'
    }[Language];

    /**
     * [优化点 4] 优化 waitForElement，缩小观察范围
     */
    const waitForElement = (selectors) => new Promise(resolve => {
        const selArray = Array.isArray(selectors) ? selectors : [selectors];
        const find = () => { for (const s of selArray) { const ele = document.querySelector(s); if (ele) return ele; } return null; };
        let element = find();
        if (element) return resolve(element);

        const observer = new MutationObserver(() => {
            element = find();
            if (element) { observer.disconnect(); resolve(element); }
        });

        const root = document.querySelector('#bilibili-player') || document.documentElement;
        observer.observe(root, { childList: true, subtree: true });
    });

    const createSelector = (options, selectedValue, className) => {
        const select = document.createElement('select');
        select.className = `bui-select ${className || ''}`;
        select.style.cssText = `background: #2b2b2b; color: white; border: 1px solid #444; padding: 2px 5px; border-radius: 4px; height: 22px; font-size: 12px; vertical-align: middle; flex-grow: 1;`;
        select.innerHTML = options.map(opt => `<option value="${opt}"${opt === selectedValue ? ' selected' : ''}>${opt}</option>`).join('');
        return select;
    };
    
    /**
     * [优化点 3] 专门的 UI 更新函数
     */
    const updateCdnSelectorUI = (newCdnList) => {
        const cdnSelect = document.querySelector('select.cdn-ultimate-select');
        if (cdnSelect) {
            cdnList = newCdnList; // 更新全局 CDN 列表
            const currentSelectedCdn = getSelectedCdn();
            cdnSelect.innerHTML = cdnList.map(cdn =>
                `<option value="${cdn}"${cdn === currentSelectedCdn ? ' selected' : ''}>${cdn}</option>`
            ).join('');
        }
    };

    const injectPlayerUI = async () => {
        if (isMobile) return;
        const settingsBar = await waitForElement('.bpx-player-ctrl-setting-others');
        if (document.querySelector('.cdn-ultimate-container')) return;
        log('播放器设置面板已找到，准备注入UI...');

        // 获取数据
        await updateRegionList();
        const storedRegion = GM_getValue(STORED_REGION_KEY, regionList[0]);
        const initialCdnList = await getCdnListByRegion(storedRegion);
        cdnList = initialCdnList; // 初始化全局 CDN 列表

        // 创建 UI
        const container = document.createElement('div');
        container.className = 'cdn-ultimate-container';
        
        const title = document.createElement('div');
        title.className = 'bpx-player-ctrl-setting-others-title';
        title.textContent = SettingsBarTitle;
        container.appendChild(title);

        // 地区选择
        const regionRow = document.createElement('div');
        regionRow.className = 'bpx-player-ctrl-setting-item';
        regionRow.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 0 16px;';
        const regionLabel = document.createElement('span');
        regionLabel.textContent = '地区';
        regionLabel.style.flexShrink = '0';
        const regionSelect = createSelector(regionList, storedRegion);
        regionSelect.addEventListener('change', async (e) => {
            const selectedRegion = e.target.value;
            GM_setValue(STORED_REGION_KEY, selectedRegion);
            log(`地区已切换至: ${selectedRegion}`);
            const newCdnList = await getCdnListByRegion(selectedRegion); // 获取数据
            updateCdnSelectorUI(newCdnList); // 更新 UI
        });
        regionRow.appendChild(regionLabel);
        regionRow.appendChild(regionSelect);
        container.appendChild(regionRow);

        // CDN 选择
        const cdnRow = document.createElement('div');
        cdnRow.className = 'bpx-player-ctrl-setting-item';
        cdnRow.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 0 16px;';
        const cdnLabel = document.createElement('span');
        cdnLabel.textContent = 'CDN';
        cdnLabel.style.flexShrink = '0';
        const cdnSelect = createSelector(cdnList, getSelectedCdn(), 'cdn-ultimate-select');
        cdnSelect.addEventListener('change', (e) => {
            GM_setValue(STORED_CDN_NODE_KEY, e.target.value);
            log(`CDN 已选择: ${e.target.value}，刷新页面后生效。`);
            location.reload();
        });
        cdnRow.appendChild(cdnLabel);
        cdnRow.appendChild(cdnSelect);
        container.appendChild(cdnRow);

        settingsBar.appendChild(container);
        log('CDN 切换器 UI 注入成功！');
    };

    // --- 主函数 ---
    log('脚本启动...');
    interceptNetworkRequests(unsafeWindow);
    hookWindowPlayInfo();
    hookMobileOptions();
    if (!isMobile) {
        injectPlayerUI();
    } else {
        log('移动端模式运行，UI 将不会注入。');
    }

})();